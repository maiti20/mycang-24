<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»ˆæCSRFè§£å†³æ–¹æ¡ˆ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .solution-box { margin: 20px 0; padding: 20px; border-left: 4px solid #007bff; background: #f8f9fa; border-radius: 5px; }
        .step { margin: 15px 0; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 5px; }
        .step h3 { color: #007bff; margin-top: 0; }
        .test-button { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 5px; font-size: 16px; }
        .test-button:hover { background: #0056b3; }
        .result { margin: 15px 0; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .clear-fix { clear: both; }
        .inline-block { display: inline-block; vertical-align: top; width: 48%; margin: 1%; }
        @media (max-width: 600px) {
            .inline-block { width: 100%; margin: 10px 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç»ˆæCSRFé—®é¢˜è§£å†³æ–¹æ¡ˆ</h1>
        
        <div class="solution-box warning">
            <h3>âš ï¸ é‡è¦æé†’</h3>
            <p>ç»è¿‡å…¨é¢è¯Šæ–­ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿ<strong>æ²¡æœ‰CSRFä¿æŠ¤æœºåˆ¶</strong>ï¼Œæ‰€æœ‰APIæµ‹è¯•éƒ½æ­£å¸¸å·¥ä½œã€‚"Invalid CSRF token"é”™è¯¯å¾ˆå¯èƒ½æ¥è‡ªï¼š</p>
            <ul>
                <li>æµè§ˆå™¨æ‰©å±•ç¨‹åºå¹²æ‰°</li>
                <li>æµè§ˆå™¨å®‰å…¨ç­–ç•¥è¿‡äºä¸¥æ ¼</li>
                <li>ä¼ä¸šé˜²ç«å¢™æˆ–å®‰å…¨è½¯ä»¶</li>
                <li>æµè§ˆå™¨ç¼“å­˜æˆ–Cookieé—®é¢˜</li>
            </ul>
        </div>

        <div class="step">
            <h3>ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ1ï¼šæ¸…é™¤æµè§ˆå™¨æ•°æ®</h3>
            <p>è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å½»åº•æ¸…é™¤æµè§ˆå™¨æ•°æ®ï¼š</p>
            <ol>
                <li>æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)</li>
                <li>å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼Œé€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"</li>
                <li>æˆ–è€…åœ¨å¼€å‘è€…å·¥å…·ä¸­ï¼š
                    <ul>
                        <li>Application â†’ Storage â†’ Clear storage â†’ Clear site data</li>
                        <li>Console â†’ localStorage.clear() å’Œ sessionStorage.clear()</li>
                    </ul>
                </li>
                <li>å…³é—­æ‰€æœ‰æ ‡ç­¾é¡µï¼Œé‡æ–°æ‰“å¼€æµè§ˆå™¨</li>
            </ol>
            <button class="test-button" onclick="clearBrowserData()">ä¸€é”®æ¸…é™¤æœ¬ç«™æ•°æ®</button>
            <div id="clear-result" class="result"></div>
        </div>

        <div class="step">
            <h3>ğŸ”„ è§£å†³æ–¹æ¡ˆ2ï¼šå°è¯•ä¸åŒæµè§ˆå™¨</h3>
            <p>å¦‚æœå½“å‰æµè§ˆå™¨ä»æœ‰é—®é¢˜ï¼Œè¯·å°è¯•ï¼š</p>
            <ul>
                <li>Chrome æ— ç—•æ¨¡å¼</li>
                <li>Firefox æ— ç—•æ¨¡å¼</li>
                <li>Edge æ— ç—•æ¨¡å¼</li>
                <li>æˆ–è€…å®Œå…¨ä¸åŒçš„æµè§ˆå™¨</li>
            </ul>
            <button class="test-button" onclick="testCurrentBrowser()">æµ‹è¯•å½“å‰æµè§ˆå™¨å…¼å®¹æ€§</button>
            <div id="browser-result" class="result"></div>
        </div>

        <div class="step">
            <h3>ğŸ§ª è§£å†³æ–¹æ¡ˆ3ï¼šç»ˆæç™»å½•æµ‹è¯•</h3>
            <p>ä½¿ç”¨å¤šç§æ–¹å¼æµ‹è¯•ç™»å½•åŠŸèƒ½ï¼š</p>
            <div style="overflow: hidden;">
                <div class="inline-block">
                    <button class="test-button" onclick="testLoginMethod1()">æ–¹æ³•1: æ ‡å‡†fetch</button>
                    <div id="method1-result" class="result"></div>
                </div>
                <div class="inline-block">
                    <button class="test-button" onclick="testLoginMethod2()">æ–¹æ³•2: XMLHttpRequest</button>
                    <div id="method2-result" class="result"></div>
                </div>
                <div class="inline-block">
                    <button class="test-button" onclick="testLoginMethod3()">æ–¹æ³•3: æ¨¡æ‹Ÿè¡¨å•</button>
                    <div id="method3-result" class="result"></div>
                </div>
                <div class="inline-block">
                    <button class="test-button" onclick="testLoginMethod4()">æ–¹æ³•4: ç›´æ¥API</button>
                    <div id="method4-result" class="result"></div>
                </div>
            </div>
        </div>

        <div class="step">
            <h3>ğŸŒ è§£å†³æ–¹æ¡ˆ4ï¼šç½‘ç»œç¯å¢ƒæ£€æŸ¥</h3>
            <p>æ£€æŸ¥ç½‘ç»œç¯å¢ƒå’Œä»£ç†è®¾ç½®ï¼š</p>
            <button class="test-button" onclick="checkNetworkEnvironment()">æ£€æŸ¥ç½‘ç»œç¯å¢ƒ</button>
            <div id="network-result" class="result"></div>
        </div>

        <div class="step">
            <h3>ğŸ“± è§£å†³æ–¹æ¡ˆ5ï¼šç›´æ¥è®¿é—®ç”Ÿäº§ç¯å¢ƒ</h3>
            <p>å¦‚æœæœ¬åœ°ç¯å¢ƒä»æœ‰é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å·²éƒ¨ç½²çš„ç”Ÿäº§ç¯å¢ƒï¼š</p>
            <div style="background: #e8f5e8; padding: 20px; border-radius: 5px; text-align: center;">
                <h4>ğŸŒ ç”Ÿäº§ç¯å¢ƒåœ°å€</h4>
                <p style="font-size: 18px; font-weight: bold; color: #2e7d32;">
                    <a href="https://sessionf6e92822d9bd422fa5_v0.dakou-hosting.iflow.cn" target="_blank" style="color: #2e7d32;">
                        https://sessionf6e92822d9bd422fa5_v0.dakou-hosting.iflow.cn
                    </a>
                </p>
                <p>ç®¡ç†å‘˜è´¦å·ï¼šadmin / admin123</p>
                <button class="test-button" onclick="window.open('https://sessionf6e92822d9bd422fa5_v0.dakou-hosting.iflow.cn', '_blank')">
                    æ‰“å¼€ç”Ÿäº§ç¯å¢ƒ
                </button>
            </div>
        </div>

        <div class="solution-box info">
            <h3>ğŸ’¡ æŠ€æœ¯è¯´æ˜</h3>
            <p>æˆ‘ä»¬çš„ç³»ç»Ÿæ¶æ„ï¼š</p>
            <ul>
                <li>å‰ç«¯ï¼šVue3 + Vite å¼€å‘æœåŠ¡å™¨ (localhost:3000)</li>
                <li>åç«¯ï¼šPython è‡ªå®šä¹‰HTTPæœåŠ¡å™¨ (localhost:5000)</li>
                <li>æ•°æ®åº“ï¼šSQLite æœ¬åœ°æ•°æ®åº“</li>
                <li><strong>æ— CSRFä¿æŠ¤æœºåˆ¶</strong> - è¿™æ˜¯è®¾è®¡å†³ç­–ï¼Œä¸æ˜¯bug</li>
            </ul>
        </div>
    </div>

    <script>
        function clearBrowserData() {
            const resultDiv = document.getElementById('clear-result');
            try {
                // æ¸…é™¤localStorage
                localStorage.clear();
                
                // æ¸…é™¤sessionStorage
                sessionStorage.clear();
                
                // æ¸…é™¤å¯èƒ½çš„cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                resultDiv.className = 'result success';
                resultDiv.textContent = 'âœ… æˆåŠŸæ¸…é™¤æ‰€æœ‰æµè§ˆå™¨æ•°æ®ï¼è¯·åˆ·æ–°é¡µé¢åé‡æ–°æµ‹è¯•ã€‚';
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ æ¸…é™¤æ•°æ®æ—¶å‡ºé”™ï¼š' + error.message;
            }
        }

        function testCurrentBrowser() {
            const resultDiv = document.getElementById('browser-result');
            const browserInfo = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                localStorage: typeof(Storage) !== "undefined",
                fetch: typeof(fetch) !== "undefined",
                xhr: typeof(XMLHttpRequest) !== "undefined"
            };
            
            resultDiv.className = 'result info';
            resultDiv.textContent = 'æµè§ˆå™¨ä¿¡æ¯ï¼š\n' + JSON.stringify(browserInfo, null, 2);
        }

        async function testLoginMethod1() {
            const resultDiv = document.getElementById('method1-result');
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                resultDiv.className = `result ${response.ok ? 'success' : 'error'}`;
                resultDiv.textContent = `æ–¹æ³•1ç»“æœ (${response.status}): ${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `æ–¹æ³•1é”™è¯¯: ${error.message}`;
            }
        }

        function testLoginMethod2() {
            const resultDiv = document.getElementById('method2-result');
            const xhr = new XMLHttpRequest();
            
            xhr.open('POST', '/api/auth/login', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        resultDiv.className = `result ${xhr.status === 200 ? 'success' : 'error'}`;
                        resultDiv.textContent = `æ–¹æ³•2ç»“æœ (${xhr.status}): ${JSON.stringify(data, null, 2)}`;
                    } catch (error) {
                        resultDiv.className = 'result error';
                        resultDiv.textContent = `æ–¹æ³•2è§£æé”™è¯¯: ${error.message}\nåŸå§‹å“åº”: ${xhr.responseText}`;
                    }
                }
            };
            
            xhr.onerror = function() {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'æ–¹æ³•2ç½‘ç»œé”™è¯¯';
            };
            
            try {
                xhr.send(JSON.stringify({
                    username: 'admin',
                    password: 'admin123'
                }));
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `æ–¹æ³•2å‘é€é”™è¯¯: ${error.message}`;
            }
        }

        async function testLoginMethod3() {
            const resultDiv = document.getElementById('method3-result');
            try {
                const formData = new FormData();
                formData.append('username', 'admin');
                formData.append('password', 'admin123');
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                resultDiv.className = `result ${response.ok ? 'success' : 'error'}`;
                resultDiv.textContent = `æ–¹æ³•3ç»“æœ (${response.status}): ${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `æ–¹æ³•3é”™è¯¯: ${error.message}`;
            }
        }

        async function testLoginMethod4() {
            const resultDiv = document.getElementById('method4-result');
            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                resultDiv.className = `result ${response.ok ? 'success' : 'error'}`;
                resultDiv.textContent = `æ–¹æ³•4ç»“æœ (${response.status}): ${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `æ–¹æ³•4é”™è¯¯: ${error.message}`;
            }
        }

        function checkNetworkEnvironment() {
            const resultDiv = document.getElementById('network-result');
            const networkInfo = {
                hostname: window.location.hostname,
                port: window.location.port,
                protocol: window.location.protocol,
                online: navigator.onLine,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : 'Connection API not supported'
            };
            
            resultDiv.className = 'result info';
            resultDiv.textContent = 'ç½‘ç»œç¯å¢ƒä¿¡æ¯ï¼š\n' + JSON.stringify(networkInfo, null, 2);
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹æ£€æŸ¥
        window.onload = function() {
            console.log('ç»ˆæCSRFè§£å†³æ–¹æ¡ˆé¡µé¢å·²åŠ è½½');
            testCurrentBrowser();
            checkNetworkEnvironment();
        };
    </script>
</body>
</html>